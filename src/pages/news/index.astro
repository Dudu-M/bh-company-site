---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHero from '../../components/sections/PageHero.astro';
import SpotlightNews from '../../components/sections/SpotlightNews.astro';
import { getCollection } from 'astro:content';
import { Calendar } from 'lucide-astro';

// Get URL params
const url = new URL(Astro.request.url);
const categoryParam = url.searchParams.get('category') || 'all';

// Get all news articles
const allNews = await getCollection('news');

// Sort by date (newest first)
const sortedNews = allNews.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get spotlight articles (max 3)
const spotlightNews = sortedNews.filter(article => article.data.spotlight).slice(0, 3);

// Get regular articles (excluding spotlight)
const regularNews = sortedNews.filter(article => !article.data.spotlight);

// Get unique categories for filter
const categories = [...new Set(allNews.map(article => article.data.category).filter(Boolean))];

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  }).format(date);
};

const ARTICLES_PER_PAGE = 9; // Show 9 articles initially
---

<BaseLayout title="News & Updates - Beth Hakkerem">
  
  <!-- Hero -->
  <PageHero 
    title="News & Updates"
    subtitle="Stay informed about our latest developments, partnerships, and industry insights."
    backgroundImage="/blue-wallpaper.jpg"
  />

  <!-- Spotlight Section -->
  {spotlightNews.length > 0 && (
    <SpotlightNews articles={spotlightNews} />
  )}

  <!-- Main News Section -->
  <section class="section-spacing bg-neutral-50">
    <div class="container-custom">
      
      <!-- Filters & Search (stays the same) -->
      <div class="flex flex-col md:flex-row gap-4 mb-12 slide-up">
        
        <!-- Search -->
        <div class="flex-1">
          <input 
            type="text"
            id="news-search"
            placeholder="Search articles..."
            class="w-full px-6 py-3 rounded-lg border border-neutral-300 focus:border-accent-500 focus:ring-2 focus:ring-accent-500/20 outline-none transition-all"
          />
        </div>

        <!-- Category Filter -->
        <select 
        id="category-filter"
        class="px-6 py-3 rounded-lg border border-neutral-300 focus:border-accent-500 focus:ring-2 focus:ring-accent-500/20 outline-none transition-all bg-white"
        >
        <option value="all" selected={categoryParam === 'all'}>All Categories</option>
        {categories.map(category => (
            <option value={category} selected={categoryParam === category}>{category}</option>
        ))}
        </select>

        <!-- Sort -->
        <select 
          id="sort-filter"
          class="px-6 py-3 rounded-lg border border-neutral-300 focus:border-accent-500 focus:ring-2 focus:ring-accent-500/20 outline-none transition-all bg-white"
        >
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>

      <!-- News Grid -->
      <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {regularNews.map((article, index) => (
          <a 
            href={`/news/${article.slug}`}
            class="news-card group"
            data-category={article.data.category || 'uncategorized'}
            data-date={article.data.date.getTime()}
            data-title={article.data.title.toLowerCase()}
            data-excerpt={article.data.excerpt.toLowerCase()}
            data-index={index}
          >
            <article class="bg-white rounded-2xl overflow-hidden h-full transition-all duration-300 hover:shadow-xl hover:-translate-y-2">
              
              <!-- Image -->
              <div class="relative h-64 overflow-hidden">
                <img 
                  src={article.data.image} 
                  alt={article.data.title}
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                />
                {article.data.category && (
                  <div class="absolute top-4 left-4">
                    <span class="inline-block px-3 py-1 bg-accent-500 text-white rounded-full text-xs font-semibold">
                      {article.data.category}
                    </span>
                  </div>
                )}
              </div>

              <!-- Content -->
              <div class="p-6">
                <!-- Date -->
                <div class="flex items-center gap-2 text-neutral-500 text-sm mb-3">
                  <Calendar class="w-4 h-4" />
                  <time datetime={article.data.date.toISOString()}>
                    {formatDate(article.data.date)}
                  </time>
                </div>

                <!-- Title -->
                <h4 class="text-xl font-semibold text-primary-500 mb-3 group-hover:text-accent-500 transition-colors line-clamp-2">
                  {article.data.title}
                </h4>

                <!-- Excerpt -->
                <p class="text-neutral-600 line-clamp-3">
                  {article.data.excerpt}
                </p>
              </div>

            </article>
          </a>
        ))}
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-neutral-500 text-lg">No articles found matching your criteria.</p>
      </div>

      <!-- Load More Button - Hidden by default -->
    <div id="load-more-container" class="text-center mt-12" style="display: none;">
    <button 
        id="load-more-btn"
        class="inline-flex items-center px-8 py-4 bg-accent-500 text-white font-semibold rounded-lg hover:bg-accent-600 transition-all hover:scale-105 active:scale-95"
    >
        Load More
    </button>
    <p id="showing-count" class="text-neutral-500 mt-4 text-sm"></p>
    </div>
    </div>
  </section>

</BaseLayout>

<script define:vars={{ ARTICLES_PER_PAGE, categoryParam }}>
  const searchInput = document.getElementById('news-search');
  const categoryFilter = document.getElementById('category-filter');
  const sortFilter = document.getElementById('sort-filter');
  const newsGrid = document.getElementById('news-grid');
  const noResults = document.getElementById('no-results');
  const loadMoreBtn = document.getElementById('load-more-btn');
  const loadMoreContainer = document.getElementById('load-more-container');
  const showingCount = document.getElementById('showing-count');
  const newsCards = Array.from(document.querySelectorAll('.news-card'));

  let currentlyShowing = ARTICLES_PER_PAGE;

  // Set initial category from URL
  if (categoryParam && categoryParam !== 'all') {
    categoryFilter.value = categoryParam;
  }

  function filterAndSortNews(resetPagination = true) {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;
    const sortOrder = sortFilter.value;

    if (resetPagination) {
      currentlyShowing = ARTICLES_PER_PAGE;
    }

    // Update URL when category changes
    const url = new URL(window.location.href);
    if (selectedCategory === 'all') {
      url.searchParams.delete('category');
    } else {
      url.searchParams.set('category', selectedCategory);
    }
    window.history.replaceState({}, '', url);

    // Filter cards
    let visibleCards = newsCards.filter(card => {
      const cardCategory = card.dataset.category || '';
      const cardTitle = card.dataset.title || '';
      const cardExcerpt = card.dataset.excerpt || '';
      
      const matchesSearch = cardTitle.includes(searchTerm) || cardExcerpt.includes(searchTerm);
      const matchesCategory = selectedCategory === 'all' || cardCategory === selectedCategory;
      
      return matchesSearch && matchesCategory;
    });

    // Sort cards
    visibleCards.sort((a, b) => {
      const dateA = parseInt(a.dataset.date || '0');
      const dateB = parseInt(b.dataset.date || '0');
      
      return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
    });

    // Hide all cards first
    newsCards.forEach(card => card.style.display = 'none');

    const totalVisible = visibleCards.length;
    
    if (totalVisible > 0) {
      // Show cards up to currentlyShowing
      const cardsToShow = visibleCards.slice(0, currentlyShowing);
      cardsToShow.forEach(card => card.style.display = 'block');
      
      newsGrid.style.display = 'grid';
      noResults.classList.add('hidden');

      // Show button ONLY if there are more articles to load
      if (totalVisible > currentlyShowing) {
        loadMoreContainer.style.display = 'block';
        showingCount.textContent = `Showing ${currentlyShowing} of ${totalVisible} articles`;
      } else {
        loadMoreContainer.style.display = 'none';
        showingCount.textContent = '';
      }

    } else {
      // No results
      newsGrid.style.display = 'none';
      noResults.classList.remove('hidden');
      loadMoreContainer.style.display = 'none';
      showingCount.textContent = '';
    }
  }

  function loadMore() {
    currentlyShowing += ARTICLES_PER_PAGE;
    filterAndSortNews(false);
    
    // Smooth scroll to first newly loaded article
    setTimeout(() => {
      const visibleCards = Array.from(newsCards).filter(card => card.style.display !== 'none');
      const scrollTarget = visibleCards[currentlyShowing - ARTICLES_PER_PAGE];
      if (scrollTarget) {
        scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  }

  // Event listeners
  searchInput.addEventListener('input', () => filterAndSortNews(true));
  categoryFilter.addEventListener('change', () => filterAndSortNews(true));
  sortFilter.addEventListener('change', () => filterAndSortNews(true));
  loadMoreBtn.addEventListener('click', loadMore);

  // Initial load with URL parameter
  filterAndSortNews(false);
</script>